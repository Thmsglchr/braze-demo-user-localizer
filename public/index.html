<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Braze Demo User Localizer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* (Same styles as before, omitted for brevity; keep your existing styles) */
    /* Just ensure #result starts hidden and uses pre-wrap */
    #result {
      display: none;
      margin-top: 24px;
      white-space: pre-wrap;
      font-size: 1em;
      padding: 14px;
      background: #f5ecff;
      border-radius: 16px;
      box-shadow: 0 2px 10px 0 rgba(128, 30, 215, 0.07);
      color: #801ED7;
      border: 1px solid #e1d6fa;
      min-height: 24px;
      word-break: break-word;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Your existing logo, heading, and form inputs -->
    <h1>Braze Demo User Localizer</h1>
    <form id="localizerForm" autocomplete="off">
      <label for="apiKey">Braze API Key:</label>
      <input
        type="password"
        id="apiKey"
        name="apiKey"
        required
        placeholder="Paste your REST API key"
        autocomplete="off"
      />

      <label for="apiEndpoint">Braze Dashboard Server:</label>
      <input
        type="text"
        id="apiEndpoint"
        name="apiEndpoint"
        required
        value="https://rest.fra-02.braze.eu/"
      />

      <label for="totalUsers">Total Users (max 10000):</label>
      <input
        type="number"
        id="totalUsers"
        name="totalUsers"
        value="100"
        min="1"
        max="10000"
        required
      />

      <label for="idPrefix">ID Prefix:</label>
      <input
        type="text"
        id="idPrefix"
        name="idPrefix"
        value="DEMO"
        required
        maxlength="12"
      />

      <label for="config">CONFIG JSON:</label>
      <textarea
        id="config"
        name="config"
        required
        rows="15"
        cols="80"
      >{
  "groups": [
    {
      "label": "French users",
      "weight": 0.6,
      "country": "FR",
      "language": "fr",
      "time_zone": "Europe/Paris",
      "cities": ["Paris", "Lyon", "Marseille", "Lille"],
      "first_names_male": ["Lucas", "Nathan", "Mehdi", "Hugo"],
      "first_names_female": ["Léa", "Emma", "Camille", "Sarah"],
      "last_names": ["Martin", "Dubois", "Durand", "Petit"]
    },
    {
      "label": "German users",
      "weight": 0.4,
      "country": "DE",
      "language": "de",
      "time_zone": "Europe/Berlin",
      "cities": ["Berlin", "Munich", "Frankfurt", "Hamburg"],
      "first_names_male": ["Lukas", "Jonas", "Paul", "Ali"],
      "first_names_female": ["Anna", "Sophie", "Maria", "Leonie"],
      "last_names": ["Müller", "Schmidt", "Schneider", "Weber"]
    }
  ]
}</textarea>

      <button type="submit">Send to Braze</button>
    </form>

    <div id="result"></div>
  </div>
  <div class="footer" id="footer-year">
    Thomas G.T. — Braze Demo User Localizer — <span id="year"></span>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Helpers for weighted random selection
    function pickWeightedGroup(groups) {
      const r = Math.random();
      let sum = 0;
      for (const g of groups) {
        sum += Number(g.weight);
        if (r < sum) return g;
      }
      return groups[groups.length - 1];
    }

    function pickRandom(arr) {
      if (!Array.isArray(arr) || arr.length === 0) return '';
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getGender() {
      return Math.random() < 0.5 ? 'male' : 'female';
    }

    async function sendBatch(batch, apiKey, apiEndpoint) {
      const baseUrl = apiEndpoint.replace(/\/+$/, '');
      const url = `${baseUrl}/generate-batch`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apiKey, batch }),
      });
      const text = await res.text();
      return text;
    }

    document.getElementById('localizerForm').onsubmit = async (e) => {
      e.preventDefault();

      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.textContent = '';

      const data = Object.fromEntries(new FormData(e.target));

      try {
        data.config = JSON.parse(data.config);
      } catch {
        resultDiv.textContent = 'Invalid JSON in CONFIG!';
        return;
      }

      // Enforce max users limit
      let totalUsers = parseInt(data.totalUsers, 10);
      if (totalUsers > 10000) {
        resultDiv.textContent = 'Total users capped at 10,000.';
        totalUsers = 10000;
      } else if (totalUsers < 1) {
        resultDiv.textContent = 'Total users must be at least 1.';
        return;
      }

      resultDiv.textContent = `⏳ Generating ${totalUsers} users...\n`;

      // Generate users in JS:
      const users = [];
      for (let i = 1; i <= totalUsers; i++) {
        const group = pickWeightedGroup(data.config.groups);
        const gender = getGender();
        const firstName =
          gender === 'male'
            ? pickRandom(group.first_names_male)
            : pickRandom(group.first_names_female);
        users.push({
          external_id: data.idPrefix + i,
          country: group.country,
          language: group.language,
          time_zone: group.time_zone,
          home_city: pickRandom(group.cities),
          first_name: firstName,
          last_name: pickRandom(group.last_names),
          gender,
        });
      }

      // Send batches sequentially:
      const BATCH_SIZE = 75;
      let batchNumber = 0;

      for (let i = 0; i < users.length; i += BATCH_SIZE) {
        batchNumber++;
        const batch = users.slice(i, i + BATCH_SIZE);
        resultDiv.textContent += `Sending batch ${batchNumber} (${batch.length} users)...\n`;

        try {
          const responseText = await sendBatch(
            batch,
            data.apiKey,
            data.apiEndpoint
          );
          resultDiv.textContent += `Batch ${batchNumber} response: ${responseText}\n\n`;
          // Scroll down so user sees latest log
          resultDiv.scrollTop = resultDiv.scrollHeight;
        } catch (err) {
          resultDiv.textContent += `Batch ${batchNumber} error: ${err.message}\n\n`;
          break;
        }
      }
      resultDiv.textContent += '✅ All done!\n';
    };
  </script>
</body>
</html>